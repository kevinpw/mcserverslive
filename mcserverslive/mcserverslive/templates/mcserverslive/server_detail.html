{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block auth_bar %}
{% include 'auth_bar.html' %}
{% endblock %}

{% block content %}
<div>

	<div id="pk" class="display_none">{{ server.pk }}</div>
	<div id="user_pk" class="display_none">{{ request.user.pk }}</div>

	{% with pk=server.pk %}

	<form id="all_comments_form" action="{% url 'server_comments' pk %}"></form>

	<div class="page-header">
		<h1><div id="{{ pk }}__server_name" class="current_data"></div></h1>
	</div><br />

	<div class="btn-group" style="margin-bottom: 3%;">
		<button class="btn btn-lg btn-primary" type="submit" form="all_comments_form">Comments</button>
		<button class="btn btn-lg btn-success" type="button" onclick="voteSubmit();">Vote for it!</button>
	</div>

	<div id="vote_message"></div>

	<div class="row">
		<div id="server_banner" style="margin-top: 5%; padding: 1%;">
			<img id="{{ pk }}__banner" class="img-responsive center-block current_data" src="" />
		</div>
	</div>

	<div id="{{ pk }}__motd" class="current_data" style="margin-top: 5%;"></div>

	<h2 class="sub-header">Current Info</h2>
	<div class="table-responsive">
		<table class="table table-striped">
			<tr><td>Version</td><td><div id="{{ pk }}__version" class="current_data"></div></td></tr>
			<tr><td>IP</td><td>{{ server.ip }}:{{ server.port }}</td></tr>
			<tr><td>Game type</td><td><div id="{{ pk }}__game_type" class="current_data"></div></td></tr>
			<tr><td>Max players</td><td><div id="{{ pk }}__max_players"class="current_data"></div></td></tr>
			<tr><td>Num players</td><td><div id="{{ pk }}__num_players" class="current_data"></div></td></tr>
			<tr><td>Votes</td><td><div id="{{ pk }}__votes" class="current_data"></div></td></tr>
			{% if server.website %}
				<tr><td>Website</td><td><div id="{{ pk }}__website" class="current_data"></div></td></tr>
			{% endif %}
			<tr><td>Last queried</td><td><div id="{{ pk }}__last_queried" class="current_data"></div></td></tr>
		</table>
	</div>

	<h2 class="sub-header">Current Description</h2>
		{{ server.description }}

	<h2 class="sub-header">Current Plugins</h2>
	<p id="{{ pk }}__plugins" class="current_data"></p>
{% comment %}
	<h2 class="sub-header">Number of Players History</h2>
	<div id="flot_shell" class="flot_shell">
		<div id="flot_num_players" class="flot"></div>
	</div>		
{% endcomment %}
	<h2 class="sub-header">Recent Comments</h2>
	<hr />

	{% if server.servercomment_set %}
		{% for comment in server.servercomment_set.all reversed %}
			{% if forloop.counter0 < 10 %}
				{% include 'servercomment_list_item.html' %}
			{% endif %}
		{% endfor %}
	{% else %}
		<p>No comments.</p>
	{% endif %}

	{% endwith %}

</div>

<script>

// voting
function voteSubmit() {
	var user_pk = $('#user_pk').html();
	if(user_pk=='None') {
		$("#vote_message").html("Login to vote!");
	} else {
		Dajaxice.mcserverslive.vote(vote_result,{'user_pk': user_pk, 'pk': $('#pk').html() });
	}
}
function vote_result(data) {
	$("#vote_message").html(data.data);
}

// flot
function Plot(flot_id, d, ymin, ymax) {

	var options = {

		series: {
			lines: { show: true, fill: true }
		},
		xaxis: { 
			mode: "time",
			twelveHourClock: true,
		},
		yaxis: {
			min: ymin,
			max: ymax
		}

	}
	var plot = $.plot(flot_id, [d], options);
	return plot
}

function makePlot(data) {
	
	var flot_id = data.flot_id;
	var ymax = $(data.ymax_id).html();
	var ymin = -1*(ymax/4);
	var data = data.data;	
	var d = [];

	for(var i in data){
		if(data[i] == null) data[i] = ymin;
		d.push([parseInt(i), data [i]]);
	}

	d.sort(function(a,b){return a[0]-b[0]});

	var plot = Plot(flot_id, d, ymin, ymax);
	plot.draw();
}

// document ready
$(function() {

	// var assignments
	var pk = $("#pk").html();
	var flot_id = "#flot_num_players";
	var ymax_id = "#"+pk+"__max_players";

	// var assignments
	var variables = [];
	var servers = [];
	var pair = [];
	$(".current_data").each(function(){
		pair = $(this).attr('id').split("__");
		servers.push(pair[0]);
		variables.push(pair[1]);
	});
	servers = ArrayUnique(servers);
	variables = ArrayUnique(variables);

	// onload
	Dajaxice.mcserverslive.get_current_data(getCurrentData, {'servers': servers, 'variables': variables });
	Dajaxice.mcserverslive.get_plot_data(makePlot, {'pk': pk, 'flot_id': flot_id, 'ymax_id': ymax_id} );

	// updates
	setInterval( function() {
		Dajaxice.mcserverslive.get_current_data(getCurrentData, {'servers': servers, 'variables': variables })
		}, 10000 
	);
	setInterval( function() {
		Dajaxice.mcserverslive.get_plot_data(makePlot, {'pk': pk, 'flot_id': flot_id, 'ymax_id': ymax_id})
		}, 20000 
	);


});
</script>

{% endblock %}
